<script>
  let minutes = 0, seconds = 0, delay = 3;
  let state = 'stopped';
  let mainRem = 0, delayRem = 0;
  let msTimer, secTimer, targetTime = 0;

  function updateMain(t) {
    const m = Math.floor(t / 60), s = t % 60;
    document.getElementById('min').textContent = m.toString().padStart(2, '0');
    document.getElementById('sec').textContent = s.toString().padStart(2, '0');
  }

  function updateMS() {
    const now = Date.now();
    const rem = Math.max(0, targetTime - now);
    document.getElementById('ms').textContent = String(rem % 1000).padStart(3, '0');
  }

  function adjust(unit, delta) {
    if (state !== 'stopped') return;
    if (unit === 'minutes') minutes = Math.max(0, minutes + delta);
    else seconds = Math.max(0, seconds + delta);
    mainRem = minutes * 60 + seconds;
    updateMain(mainRem);
  }

  function adjustDelay(d) {
    if (state !== 'stopped') return;
    delay = Math.max(0, delay + d);
    document.getElementById('startDelay').textContent = delay;
  }

  function setBtn(id, text, cls) {
    const b = document.getElementById(id);
    b.textContent = text;
    b.className = cls;
  }

  function playWhistle(short = false) {
    const audio = new Audio('whistle.wav');
    audio.play().catch(e => console.warn('Audio play failed:', e));
    if (short) {
      setTimeout(() => {
        audio.pause();
        audio.currentTime = 0;
      }, 400); // nur ca. 0.4 Sekunden für Startpfiff
    }
  }

  function startOrResume() {
    if (state === 'running' || state === 'delay') return;
    if (state === 'paused') return resumeTimer();

    mainRem = minutes * 60 + seconds;
    delayRem = delay;
    state = delay > 0 ? 'delay' : 'running';

    setBtn('btnStart', 'Pause', 'orange');
    setTimerColor(state === 'delay' ? 'var(--green)' : 'var(--fg)');
    updateMain(state === 'delay' ? delayRem : mainRem);

    if (state === 'delay') {
      playWhistle(true); // Startpfiff sofort
      delayRem--;
      updateMain(delayRem);
    } else {
      beginMain();
    }

    secTimer = setInterval(tick, 1000);
    msTimer = setInterval(updateMS, 50);
  }

  function tick() {
    if (state === 'delay') {
      delayRem--;
      if (delayRem <= 0) {
        state = 'running';
        setTimerColor('var(--fg)');
        updateMain(mainRem);
        beginMain();
      } else {
        updateMain(delayRem);
      }
    } else if (state === 'running') {
      mainRem--;
      if (mainRem <= 0) {
        endTimer();
      } else {
        updateMain(mainRem);
      }
    }
  }

  function beginMain() {
    targetTime = Date.now() + mainRem * 1000;
  }

  function stopTimer() {
    if (state === 'running' || state === 'delay') {
      state = 'paused';
      clearInterval(secTimer);
      clearInterval(msTimer);
      setBtn('btnStart', 'Resume', 'green');
    }
  }

  function resumeTimer() {
    state = 'running';
    setBtn('btnStart', 'Pause', 'orange');
    beginMain();
    secTimer = setInterval(tick, 1000);
    msTimer = setInterval(updateMS, 50);
  }

  function endTimer() {
    clearInterval(secTimer);
    clearInterval(msTimer);
    updateMain(0);
    playWhistle(); // Endpfiff (vollständig)
    document.getElementById('ms').textContent = '000';
    state = 'stopped';
    setTimerColor('var(--red)');
    setBtn('btnStart', 'Start', 'green');
  }

  function resetTimer() {
    clearInterval(secTimer);
    clearInterval(msTimer);
    state = 'stopped';
    setTimerColor('var(--fg)');
    mainRem = minutes * 60 + seconds;
    updateMain(mainRem);
    document.getElementById('ms').textContent = '000';
    setBtn('btnStart', 'Start', 'green');
  }

  function setTimerColor(c) {
    document.getElementById('timer').style.color = c;
  }

  function toggleMode() {
    document.body.classList.toggle('light');
  }

  resetTimer();
</script>
